{% extends 'base.html' %}
{% block title %} ZAPTUSS - Dashboard{% endblock %}

{% block pagewrapper %}
<div class="page-wrapper">
    <!-- ============================================================== -->
    <!-- Container fluid  -->
    <!-- ============================================================== -->
    <div class="container-fluid">
        <!-- ============================================================== -->
        <!-- Bread crumb and right sidebar toggle -->
        <!-- ============================================================== -->
        <div class="row page-titles">
            <div class="col-md-5 col-8 align-self-center">
                <h3 class="text-themecolor m-b-0 m-t-0">Dashboard</h3>
                <ol class="breadcrumb">
                    <li class="breadcrumb-item"><a href="javascript:void(0)">Home</a></li>
                    <li class="breadcrumb-item active">Dashboard</li>
                </ol>
            </div>
            <div class="col-md-7 col-4 justify-content-end">
                <h3 class="text-themecolor" style="text-align: end">Modo Light</h3>
                <div class="switch group-switch " style="">
                    <div class="row flex-row justify-content-end p-r-20" style="padding-left: 15px">
                        <label class="" id="id_label_name_group">On
                            <input type="checkbox" checked="checked" id="id_switch_name_link">
                            <span class="lever switch-col-amber"></span>
                        </label>
                        <label class="text-themecolor" id="id_label_link_group">Off</label>
                    </div>
                    <button id="statusid">get status</button>
                </div>
            </div>
        </div>
        <!-- ============================================================== -->
        <!-- End Bread crumb and right sidebar toggle -->
        <!-- ============================================================== -->
        <!-- ============================================================== -->
        <!-- Start Page Content -->
        <!-- ============================================================== -->
        <div class="card ">
            <div class="card-body">
                <div class="row">
                    <div class="col-lg-12 justify-content-start">
                        <h4 class="card-title text-themecolor">Sessões do Whatsapp</h4>
                    </div>

                    <div class="row container-fluid">
                        <label class="col-lg-8 col-md-8 col-sm-8  col-xl-8">Necessário 1 chip cadastrado no Whatsapp
                            para iniciar cada sessão</label>
                        <div class=" col-lg-4 col-md-4 col-sm-4  col-xl-4 row justify-content-end">
                            <! -- SECTIONS -->
                            <!-- add section -->
                            <button class="btn  btn-outline-success"
                                    type="submit"
                                    id='id_add_section'
                                    data-addSectionButton-section="1"
                                    name="add_section"
                                    value="add" style="height: 33px">Adicionar
                            </button>
                            <! -- SECTIONS -->
                            <!-- remove section -->
                            <button class="btn btn-outline-danger m-l-10 m-r-20"
                                    type="submit"
                                    name='remove_section'
                                    id="id_remove_section"
                                    data-removeSectionButton-section="1"
                                    value="remove" style="height: 33px">Remover
                            </button>
                        </div>
                    </div>
                </div>

                <! -- SECTIONS -->
                <!-- NAV TABS -->
                <div class="tabs tabs-section container " id='id_tabs_section'>
                    <ul class="nav nav-tabs" role="tablist" id='id_nav_tabs_section' data-navTabHolder-section="1">
                        <li class="nav-item section-tab-item" data-section="1">
                            <a class="nav-link nav-link-section active" data-toggle="tab" data-for-section-tab="1"
                               data-section="1"
                               data-messageTab-section="1" id="st-1"
                               href="#home" role="tab">
                                <span class="hidden-sm-up"><i class="ti-home"></i></span>
                                <span class="hidden-xs-down">Sessão 1</span>
                            </a>
                        </li>
                    </ul>
                    <! -- SECTIONS -->
                    <!-- TAB PANES -->
                    <div class="tab-content tabcontent-border" id="id_section_content_holder">
                        <div class="tab-pane tab-pane-sections active" data-section="1"
                             id="sp-1" role="tabpanel">
                            <div class=" row p-10 d-flex justify-content-around p-r-20">
                                <!-- start top row -->
                                <div class="col-md-12">
                                    <!-- ============================================================== -->
                                    <!--  MESSAGES CARD -->
                                    <!-- ============================================================== -->
                                    <div class="card messages-card-honeycomb">
                                        <img class="card-img-top honeycomb honeycomb-top-right"
                                             src="../static/assets/images/gold_honeycomb_top_right.png"
                                             alt="Card image">
                                        <div class="card-body card-img-overlay">
                                            <div class="row">
                                                <div class="col-lg-12 justify-content-start">
                                                    <h4 class="card-title text-themecolor">Mensagens</h4>
                                                </div>
                                                <div class="col-lg-12 justify-content-end">
                                                    <div class="row justify-content-end">
                                                        <!-- add message -->
                                                        <button class="btn btn-outline-success add-message"
                                                                type="submit"
                                                                id='id-add-message-s-1'
                                                                data-section="1"
                                                                name="add_message">Adicionar
                                                        </button>
                                                        <!-- remove section -->
                                                        <button class="btn btn-outline-danger m-l-10 m-r-20 remove-message"
                                                                type="submit"
                                                                data-section="1"
                                                                name='remove_message'
                                                                id="id-remove-message-s-1">Remover
                                                        </button>
                                                    </div>
                                                </div>
                                            </div>

                                            <!-- TABS AND TAB CONTAINER -->
                                            <div class="tabs tabs-msg container " id='id_tabs-msg'>
                                                <ul class="nav nav-tabs" role="tablist" id='id_nav_tabs'
                                                    data-navTabHolder-message="1" data-section="1">
                                                    <li class="nav-item message-tab-item" data-section="1">
                                                        <a class="nav-link nav-link-msg active" data-toggle="tab"
                                                           data-for-tab="1"
                                                           data-section="1"
                                                           data-messageTab-section="1" id="1"
                                                           href="#home" role="tab">
                                                            <span class="hidden-sm-up"><i class="ti-home"></i></span>
                                                            <span class="hidden-xs-down">M1</span>
                                                        </a>
                                                    </li>
                                                </ul>
                                                <!-- Tab panes -->
                                                <div class="tab-content tabcontent-border" id="id_content_holder"
                                                     data-section="1">
                                                    <div class="tab-pane tab-pane-msg active" data-id='1'
                                                         data-section="1"
                                                         id="1"
                                                         data-messagePane-section="1" role="tabpanel">
                                                        <div class=" row p-10 d-flex justify-content-around p-r-10">
                                                            <!-- start top row -->
                                                            <textarea name="msg_area" cols="40" rows="12"
                                                                      class="form-control col-lg-11 m-l-30 msg-area-content"
                                                                      required=""
                                                                      id="id_msg_area_1"
                                                                      data-section="1"></textarea>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- ============================================================== -->
                                    <!-- FILE INPUT CARD -->
                                    <!-- ============================================================== -->
                                    <div class="row">
                                        <div class="col-lg-6 col-md-6">
                                            <div class="card attachimage-card-honeycomb">
                                                <img class="card-img-top honeycomb honeycomb-down-left-small"
                                                     src="../static/assets/images/gold_honeycomb_down_left.png"
                                                     alt="Card image">
                                                <div class="card-body card-img-overlay container-fluid p-t-20">
                                                    <h4 class="card-title text-themecolor">Anexar Imagem</h4>
                                                    <label for="input-file-now">Escolha uma imagem para enviar com a
                                                        mensagem</label>
                                                    <input type="file" id="input-file-now"
                                                           class="dropify image-input"
                                                           data-allowed-file-extensions="jpeg jpg png"
                                                           data-max-file-size="3M"
                                                           data-section="1"/>
                                                </div>
                                            </div>
                                        </div>
                                        <div class="col-md-6 col-lg-6">
                                            <div class=" card imagecaption-card-honeycomb">
                                                <img class="card-img-top honeycomb honeycomb-down-right-small"
                                                     src="../static/assets/images/gold_honeycomb_down_right.png"
                                                     alt="Card image">
                                                <div class="card-body card-img-overlay">
                                                    <h4 class="card-title text-themecolor">Legenda</h4>
                                                    <label>Se desejar incluir uma lengenda para imagem digite abaixo.
                                                        (opcional)</label>
                                                    <textarea name="image_caption" cols="40" rows="9"
                                                              class="form-control col-lg-auto"
                                                              required=""
                                                              id="id_image_caption"
                                                              placeholder="Digite aqui..."
                                                              data-section="1"></textarea>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    <!-- ============================================================== -->
                                    <!-- CONTACTS LIST CARD-->
                                    <!-- ============================================================== -->
                                    <form class="form-material">
                                        <div class="row">
                                            <div class="col-lg-6 col-md-6">
                                                <div class="card card-honeycomb">
                                                    <img class="card-img-top honeycomb honeycomb-top-left-small"
                                                         src="../static/assets/images/gold_honeycomb_top_left.png"
                                                         alt="Card image">
                                                    <div class="card-body card-img-overlay">
                                                        <h4 class="card-title text-themecolor">Contatos</h4>
                                                        <div class="bootstrap-table">
                                                            <div class="fixed-table-container m-t-20"
                                                                 style="height: 250px; ">
                                                                <table class="table-hover table">
                                                                    <thead class="justify-content-around">
                                                                    <tr class="justify-content-around">
                                                                        <th><h5 class="text-themecolor">Nome</h5></th>
                                                                        <th><h5 class="text-themecolor">Número</h5></th>
                                                                    </tr>
                                                                    </thead>
                                                                </table>
                                                                <div class="fixed-table-body"
                                                                     style="position: relative; height: 180px; overflow: auto; display: block;">
                                                                    <table class="table table-hover "
                                                                           data-toggle="table" data-height="100"
                                                                           data-sort-order="desc"
                                                                           data-mobile-responsive="true">
                                                                        <tbody id='id_table_holder' data-section="1">

                                                                        </tbody>
                                                                    </table>
                                                                </div>
                                                            </div>
                                                        </div>
                                                        <div class="form-group">
                                                            <label>Importar Contatos</label>
                                                            <div class="fileinput fileinput-new input-group"
                                                                 data-provides="fileinput">
                                                                <div class="form-control" data-trigger="fileinput"><i
                                                                        class="glyphicon glyphicon-file fileinput-exists"></i>
                                                                    <span
                                                                            class="fileinput-filename"
                                                                            id="id_contact_list"></span></div>
                                                                <span class="input-group-addon btn btn-default btn-file"> <span
                                                                        class="fileinput-new">Selecionar</span> <span
                                                                        class="fileinput-exists">Mudar</span>
                                            <input type="hidden" id="id_input_hidden_csv">
                                            <input class="input-csv" type="file" id="id_input_csv" accept=".csv"
                                                   name="..."
                                                   data-allowed-file-extensions="csv"
                                                   data-section="1"> </span>
                                                                <a href="#" id="id-remove-file"
                                                                   class="input-group-addon btn btn-default fileinput-exists"
                                                                   data-dismiss="fileinput">Remover</a>
                                                            </div>
                                                        </div>
                                                    </div>
                                                </div>
                                            </div>
                                            <!-- ============================================================== -->
                                            <!-- SETTINGS CARD-->
                                            <!-- ============================================================== -->
                                            <div class="col-lg-6 col-md-6">
                                                <div class="card card-honeycomb" style="height: 454px">
                                                    <img class="card-img-top honeycomb honeycomb-top-right-small"
                                                         src="../static/assets/images/gold_honeycomb_top_right.png"
                                                         alt="Card image">
                                                    <div class="card-body card-img-overlay container-fluid m-t-20">
                                                        <form class="form-material">
                                                            <h4 class="card-title text-themecolor">Configurações</h4>
                                                            <label class="card-title">Defina o Intervalo entre
                                                                Mensagens</label>
                                                            <div class="row form-group justify-content-start">
                                                                <p class="text text-themecolor">Mínimo: </p>
                                                                <input id="id_delay_min"
                                                                       class="form-control "
                                                                       type="text" name="interval_min" required=""
                                                                       placeholder="60" value="60"
                                                                       data-section="1">

                                                                <p>segundos</p>
                                                            </div>
                                                            <div class="row form-group justify-content-start">
                                                                <p class="text text-themecolor">Máximo: </p>
                                                                <input data-location="" id="id_delay_max"
                                                                       class="form-control"
                                                                       type='text' name="interval_max"
                                                                       required=""
                                                                       placeholder="180" value="180"
                                                                       data-section="1">
                                                                <p>segundos</p>
                                                            </div>
                                                            <div class="row form-group justify-content-start">
                                                                <p class="text text-themecolor">Modo de Digitação: </p>
                                                                <select class="custom-select col-12"
                                                                        id="inlineFormCustomSelect" data-section="1">
                                                                    <option value="1">Lento - digitação humana: 38 a 50
                                                                        ppm.(recomendado)
                                                                    </option>
                                                                    <option value="2">Médio - digitação humana rápida:
                                                                        maior que 70 ppm
                                                                    </option>
                                                                    <option value="3">Rápido - superhumano, sem pausas
                                                                    </option>
                                                                    <option value="4">Copia e Cola (não recomendado)
                                                                    </option>
                                                                </select>
                                                            </div>

                                                        </form>
                                                    </div>
                                                </div>
                                                <div class="container-fluid justify-content-center"
                                                     style="display: flex; align-items: center; justify-content: center;">
                                                    <button data-action="send_message" id='id-send-btn-1'
                                                            class="btn btn-warning btn-send-message m-b-30"
                                                            style="width: 100%;" data-section="1">
                                                        <i class="fa fa-send fa-lg p-10"> Iniciar Sessão</i>
                                                    </button>
                                                </div>

                                            </div>
                                        </div>
                                    </form>
                                    <!-- ============================================================== -->
                                    <!-- Acordeon -->
                                    <!-- ============================================================== -->
                                    <!--<div class="col-sm-12 col-md-12 col-lg-12 offset-lg-1">
                                        <h4 class="card-title">Sessões Iniciadas</h4>
                                        <h6 class="card-subtitle">Aqui você poderá acompanhar uma lista com as sessões iniciadas.</h6>
                                        <div id="accordion2" class="accordion" role="tablist" aria-multiselectable="true">

                                        </div>
                                    </div>-->
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>


        <!-- ============================================================== -->
        <!-- End PAge Content -->
        <!-- ============================================================== -->

    </div>
    <!-- ============================================================== -->
    <!-- End Container fluid  -->
    <!-- ============================================================== -->
    <!-- ============================================================== -->
    <!-- footer -->
    <!-- ============================================================== -->
    <footer class="footer">
        © 2020 Zaptuss é uma ferramenta do grupo Impactuss.com
    </footer>
    <!-- ============================================================== -->
    <!-- End footer -->
    <!-- ============================================================== -->
</div>
{% endblock pagewrapper %}

{% block pagescripts %}
<script type="text/javascript">
    const $ = nodeRequire("jquery")
    // =========================================
    //      GLOBAL VARIABLES
    // =========================================
    var messages = {};
    var image_path = null;
    var image_caption = null;
    var delay_min = 60; // seconds
    var delay_max = 120; // seconds
    var typing_mode;


    // =========================================
    //      START SESSION HANDLER
    // =========================================
    function sendBtnListener(event) {
        event.preventDefault();
        let contacts = {};

        let currSection = $(this).attr("data-section");
        var sectionName = `sessao-${currSection}`;
        console.log("the current section? ", currSection);

        // -------------------------------
        //      get messages
        $(`.msg-area-content[data-section='${currSection}']`).each((idx, text) => {
            messages[`${idx}`] = text.value
        });

        // -------------------------------
        //      get messages
        $(`.contact-phone-number[data-section='${currSection}']`).each((idx, elem) => {
            contacts[`${idx}`] = $(elem).text()
        });

        // -------------------------------
        //      get settings
        delay_min = $(`input#id_delay_min[data-section='${currSection}']`).val();
        delay_max = $(`input#id_delay_max[data-section='${currSection}']`).val();
        typing_mode = $(`select#inlineFormCustomSelect[data-section='${currSection}']`).val();

        // -------------------------------
        //      get image caption
        image_caption = $(`textarea[name='image_caption'][data-section='${currSection}']`).val();

        // -------------------------------
        //      get image caption
        try {
            image_path = $(`input.image-input[data-section='${currSection}']`)[0].files[0].path;
        } catch (e) {
            console.log("no image uploaded")
            image_path = null
        }

        // -------------------------------
        //      check if user can send messages
        //  TODO: get info from api to see if the user
        // is active, able to send messages, and
        // how many messages left till that monthly
        // signature expires.
        // -------------------------------
        //      START BOT
        requireQRCode(contacts, messages, delay_min, delay_max, image_path, image_caption, typing_mode, sectionName)
    }

    // =========================================
    //      GENERATE QR CODE
    // =========================================
    async function requireQRCode(contacts, messages, delay_min, delay_max, image_path, image_caption, typing_mode, sectionName) {
        const Swal = nodeRequire("sweetalert2");
        var myInterval;
        var dataReceived = {qrCode: '', isQRCodeReceived: false, isLoggedIn: false};
        var dataReceivedProxy = new Proxy(dataReceived, {
            set: (o, property, value) => {
                o[property] = value;
            },
            get: (o, property) => {
                return property in o ? o[property] : 'property not in object'
            },

        });

        eel.expose(generateQRCode_js);

        function generateQRCode_js(data) {
            dataReceivedProxy.qrCode = data[`qr_code`];
            dataReceivedProxy.isQRCodeReceived = true;
            dataReceivedProxy.isLoggedIn = data[`is_logged_in`]
        }

        const {value: qrCode} = await Swal.queue([{
            title: 'QRCode',
            confirmButtonText: 'Iniciar Sessão',
            text:
                'Clique no botão abaixo para iniciar o navegador. ' +
                'Utilizando seu celular abra o Whatsapp > Clique em Opções (3 pontinhos no canto direito) > Clique em Whatsapp Web',
            showLoaderOnConfirm: true,
            //html: `<canvas id="somecanvas"></canvas>`,
            customClass: {
                confirmButton: 'btn btn-success',
                cancelButton: 'btn btn-danger'
            },
            preConfirm: () => {
                dataReceivedProxy.isQRCodeReceived = false;
                var image_name = "session1.jpg";
                eel.start_bot_py(contacts, messages, delay_min, delay_max, image_path, image_caption, typing_mode, `${sectionName}`);
                return new Promise((resolve, reject) => {
                    // require node
                    // every seconds checks for new qrcode
                    // every seconds checks if user has logged in
                    myInterval = setInterval(() => {
                        var QRCode = nodeRequire('qrcode');
                        //var canvas = document.getElementById("somecanvas");
                        /*if (dataReceivedProxy.isQRCodeReceived === true) {
                            Swal.hideLoading();
                            Swal.disableButtons()
                            Swal.title = "Escanear QRCode";
                            QRCode.toCanvas(canvas, dataReceivedProxy.qrCode, function (error) {
                                if (error) console.error(error);
                                console.log('success!');
                            });
                            if (dataReceivedProxy.isLoggedIn === true) {
                                resolve(dataReceivedProxy.qrCode)
                                clearInterval(myInterval)
                            }
                        }*/
                        if (dataReceivedProxy.isLoggedIn === true) {
                            resolve(dataReceivedProxy.qrCode)
                            clearInterval(myInterval)
                        }
                    }, 500)
                }).then(response => {
                    //appendSection()
                })
                    .then(response => {
                        Swal.fire(
                            'Iniciando Envios!',
                            'A sessão de envios foi iniciada com sucesso.',
                            'success'
                        )
                    })
                    .catch(() => {
                        Swal.insertQueueStep({
                            icon: 'Erro',
                            title: 'Erro ao iniciar sessão'
                        })
                    })
            },
            onClose: () => {
                clearInterval(myInterval)
            }
        }]);
    }

    // =========================================
    //      HANDLE IMAGE FILE PATH
    // =========================================
    function imageFilePathListener(event) {
        var reader = new FileReader();
        reader.onload = imageIsLoaded;
        reader.readAsDataURL(this.files[0]);

        function imageIsLoaded(e) {
            image_path = e.target.result;
        }
    }

    function dropifyListener() {

        // Basic
        $('.dropify').dropify();

        // Translated
        $('.dropify-fr').dropify({
            messages: {
                default: 'Arquivo',
                replace: 'Mudar',
                remove: 'Remover',
                error: 'Erro'
            }
        });

        // Used events
        var drEvent = $('#input-file-events').dropify();

        drEvent.on('dropify.beforeClear', function (event, element) {
            return confirm("Você realmente deseja deletar o aquivo \"" + element.file.name + "\" ?");
        });

        drEvent.on('dropify.afterClear', function (event, element) {
            alert('arquivo deletado');
        });

        drEvent.on('dropify.errors', function (event, element) {
            console.log('Has Errors');
        });

        var drDestroy = $('#input-file-to-destroy').dropify();
        drDestroy = drDestroy.data('dropify')
        $('#toggleDropify').on('click', function (e) {
            e.preventDefault();
            if (drDestroy.isDropified()) {
                drDestroy.destroy();
            } else {
                drDestroy.init();
            }
        })
    }

    // =========================================
    //      IMPORT CONTACT LIST
    // =========================================
    async function inputContactListener(e) {
        // section values
        let currSection = $(this).attr("data-section");
        // declare variable tables
        var contactList = document.querySelectorAll(`.table-row-contact[data-section='${currSection}']`);
        var contactCounter = contactList.length;
        var tableHolder = $(`#id_table_holder[data-section='${currSection}']`);
        tableHolder.empty();
        sleep(1000).then(value => {
            var fileInput = document.querySelector(`.input-csv[data-section='${currSection}']`);
            console.log(fileInput.files[0]);
            var reader = new FileReader();
            reader.onload = function () {
                var tableHolder = $(`#id_table_holder[data-section='${currSection}']`);

                contactList = csvJSON(reader.result);
                var lines = reader.result.split('\n');
                for (idx in lines) {
                    if (idx >= 1 && idx < lines.length - 1) {
                        var lines_splited = lines[idx].split(',');
                        var phone_number = lines_splited[1].replace(/\D/g, '');
                        tableHolder.append(`
                            <tr class="contact-row" data-index="${idx}" data-section="${currSection}">
                                <td><h6 class="contact-name"
                                        id="id_contact_name_${idx}"
                                        data-section="${currSection}">${lines_splited[0]}</h6></td>
                                <td>
                                    <h6 class="contact-phone-number"
                                        id="id_contact_phone_number_${idx}"
                                        data-section="${currSection}">${phone_number}</h6>
                                </td>
                            </tr>
                            `);
                    }
                }
            };
            reader.readAsBinaryString(fileInput.files[0]);
        });
    }

    // =========================================
    //      CLEAR CONTACT LIST
    // =========================================
    $('a#id-remove-file').on("click", function (e) {
        e.preventDefault()
        var tableHolder = $("#id_table_holder");
        tableHolder.empty();
    });

    // ======================================
    //      HANDLE IMAGE FILE
    // ======================================
    $(".btn-file-imagefile").on(`click`, (e) => {
        e.preventDefault();
        console.log('selection clicked');
        const filters = [
            {name: 'Images', extensions: ['jpg', 'png', "jpeg"]},
        ]

        dialog.showOpenDialog({
            buttonLabel: "Selecionar Imagem",
            properties: ["openFile"],
            filters: filters
        }, (openPath) => {

        }).then(result => {
            image_path = result.filePaths[0]
            $("span#id_grab_file").text(`${result.filePaths[0]}`)
        })
    });

    // =====================================
    //      HANDLE SIDEBAR TOGGLER
    // =====================================
    $("a.sidebartoggler").on(`click`, (e) => {

    });

    // ========================================
    //     ADD AND REMOVE MESSAGES
    // =========================================
    const handleListeners = () => new Promise((resolve, reject) => {

        $(".add-message").each((index, elem) => {
            $(elem).off("click", addMessageBtnListener)
        });
        $(".remove-message").each((index, elem) => {
            $(elem).off("click", removeMessageBtnListener);
        });
        $(".input-csv").each((index, elem) => {
            $(elem).off("change", inputContactListener);
        });
        $("button[data-action='send_message']").each((index, elem) => {
            $(elem).off("click", sendBtnListener);
        });
        resolve("listeners removed")
    })
        .then(result => {
            $(".add-message").each((index, elem) => {
                $(elem).on("click", addMessageBtnListener)
            });
            $(".remove-message").each((index, elem) => {
                $(elem).on("click", removeMessageBtnListener)
            });
            $(".input-csv").each((index, elem) => {
                $(elem).on("change", inputContactListener)
            });
            $("button[data-action='send_message']").each((index, elem) => {
                $(elem).on("click", sendBtnListener);
            });
        });

    function handleButtonAddRemove() {
        document.querySelectorAll(".nav-link-msg").forEach(navLink => {
            navLink.addEventListener('click', () => {
                const listItem = navLink.parentElement;
                const navBar = listItem.parentElement;
                const tabContainer = navBar.parentElement;

                const tabNumber = navLink.dataset.forTab;
                const selectedContentTab = tabContainer.children[1];
                const tabToActivate = selectedContentTab.querySelectorAll(`.tab-pane-msg[data-id="${tabNumber}"]`);

                navBar.querySelectorAll('.nav-item').forEach(listItem => {
                    listItem.querySelector('.nav-link-msg').classList.remove('active')
                });
                selectedContentTab.querySelectorAll('.tab-pane').forEach(tabLinks => {
                    tabLinks.classList.remove('active');
                });

                navLink.classList.add('active');
                tabToActivate[0].classList.add('active');
            }, {passive: true})
        })
    }

    function addMessageBtnListener() {

        var currSection = $(this).attr("data-section");
        console.log("section ", currSection);

        var tabsList = document.querySelectorAll(`.message-tab-item[data-section='${currSection}']`);
        var tabCounter = tabsList.length;
        var tabsHolder = $(`ul#id_nav_tabs[data-section='${currSection}']`);
        var messageTabHtml = addMessageTab(tabCounter, currSection);

        // -------- add new tab to the list -------------
        tabsHolder.append(`${messageTabHtml}`);

        // -------- add new content to the list ---------
        var contentList = document.querySelectorAll(`.tab-pane-msg[data-section='${currSection}']`);
        var contentCounter = contentList.length;
        var contentHolder = $(`#id_content_holder[data-section='${currSection}']`);
        var messageContentHtml = addMessageContent(contentCounter, currSection);

        contentHolder.append(`${messageContentHtml}`);
        handleButtonAddRemove();
    }

    function removeMessageBtnListener() {
        event.preventDefault();

        var tabsList = $(".message-tab-item");
        var contentList = $(".tab-pane");

        if (tabsList.length === 1) {

        } else {
            var lastTab = tabsList.last();
            var lastContent = contentList.last();
            lastTab.addClass('animate__animated').addClass('animate__zoomOut');
            setTimeout(() => {
                lastTab.remove()
            }, 300);
            lastContent.addClass('animate__animated').addClass('animate__zoomOut');
            setTimeout(() => {
                lastContent.remove()
            }, 300);
        }
    }

    // ==========================================
    //      SECTIONS
    $("#id_add_section").on("click", function (e) {
        e.preventDefault();

        var tabsList = document.querySelectorAll(".section-tab-item");
        var tabCounter = tabsList.length;
        var tabsHolder = $("#id_nav_tabs_section");

        // add new tab to the list
        tabsHolder.append(`
            <li class="nav-item section-tab-item animate__animated animate__zoomIn" data-section="${tabCounter + 1}">
                <a class="nav-link nav-link-section" data-toggle="tab"
                    data-section="${tabCounter + 1}"
                    data-for-section-tab="${tabCounter + 1}"
                   data-messageTab-section="${tabCounter + 1}" id="st-${tabCounter + 1}"
                   href="#home" role="tab">
                    <span class="hidden-sm-up"><i class="ti-home"></i></span>
                    <span class="hidden-xs-down">Sessão ${tabCounter + 1}</span>
                </a>
            </li>
        `);

        // dealing with content
        var contentList = document.querySelectorAll(".tab-pane-sections");
        var contentCounter = contentList.length;
        var contentHolder = $("#id_section_content_holder");
        var messageSection = messageCard(0, 0, contentCounter + 1);
        var image = imageInput(contentCounter + 1);
        var caption = imageCaption(contentCounter + 1);
        var contacts = contactList(contentCounter + 1);
        var settings = settingsCard(contentCounter + 1);
        contentHolder.append(`
            <div class="tab-pane tab-pane-sections" data-section="${contentCounter + 1}"
                             id="sp-${contentCounter + 1}" role="tabpanel">
                <div class=" row p-10 d-flex justify-content-around ">
                    <div class="col-md-12">
                        ${messageSection}
                        <div class="row">
                            ${image}
                            ${caption}
                        </div>
                        <form class="form-material">
                            <div class="row">
                                ${contacts}
                                ${settings}
                            </div>
                        </form>
                </div>
            </div>
        `);
        handleAddRemoveSections();
        handleListeners(contentCounter + 1);
        dropifyListener();

    });

    $("#id_remove_section").on("click", function (e) {
        e.preventDefault();
        var tabsList = $(".section-tab-item");
        var contentList = $(".tab-pane-sections");

        if (tabsList.length === 1) {

        } else {
            var lastTab = tabsList.last();
            var lastContent = contentList.last();
            lastTab.addClass('animate__animated').addClass('animate__zoomOut');
            setTimeout(() => {
                lastTab.remove()
            }, 300);
            lastContent.addClass('animate__animated').addClass('animate__zoomOut');
            setTimeout(() => {
                lastContent.remove()
            }, 300);
        }
    });

    function handleAddRemoveSections() {
        document.querySelectorAll(".nav-link-section").forEach(navLink => {
            navLink.addEventListener('click', () => {
                const listItem = navLink.parentElement;
                const navBar = listItem.parentElement;
                const tabContainer = navBar.parentElement;

                const tabNumber = navLink.dataset.forSectionTab;
                const selectedContentTab = tabContainer.children[1];
                const tabToActivate = selectedContentTab.querySelector(`.tab-pane-sections[data-section="${tabNumber}"]`);

                navBar.querySelectorAll('.nav-item').forEach(listItem => {
                    listItem.querySelector('.nav-link-section').classList.remove('active')
                });
                selectedContentTab.querySelectorAll('.tab-pane-sections').forEach(tabLinks => {
                    tabLinks.classList.remove('active');
                });
                navLink.classList.add('active');
                tabToActivate.classList.add('active');

                // ==============================================
                //      ADD LISTENERS TO THE BUTTONS
                $(`button#id_add_message`).on("click", function (e) {
                    e.preventDefault();

                    var currSection = $(this).attr("data-section");
                    var tabsList = document.querySelectorAll(`.message-tab-item[data-section='${currSection}']`);
                    var tabCounter = tabsList.length;

                    var tabsHolder = $(`ul#id_nav_tabs[data-section='${currSection}']`);

                    // add new tab to the list
                    tabsHolder.append(`
                        <li class="nav-item message-tab-item animate__animated animate__zoomIn" data-section="${currSection}">
                            <a class="nav-link nav-link-msg" data-toggle="tab" data-for-tab="${tabCounter + 1}"
                            data-messageTab-section="${currSection}"  id="${tabCounter + 1}" data-section="${currSection}"
                            href="#home" role="tab">
                                <span class="hidden-sm-up"><i class="ti-home"></i></span>
                                <span class="hidden-xs-down">M${tabCounter + 1}</span>
                            </a>
                        </li>
                    `);

                    // dealing with content
                    var contentList = document.querySelectorAll(`.tab-pane-msg[data-section='${currSection}']`);
                    console.log("current section ", currSection, " - contentlist ", contentList);
                    var contentCounter = contentList.length;
                    var contentHolder = $(`#id_content_holder[data-section='${currSection}']`);
                    console.log("contentHolder ", contentHolder);

                    contentHolder.append(`
                    <div class="tab-pane tab-pane-msg" data-id='${contentCounter + 1}' data-messagePane-section="${currSection}"
                        data-section="${currSection}"
                            id="${contentCounter + 1}" role="tabpanel">
                            <div class=" row p-10 d-flex justify-content-around ">
                                <textarea name="msg_area" cols="40" rows="12" class="form-control col-lg-11 m-l-30 msg-area-content" required=""
                                            id="id_msg_area_${contentCounter + 1}"></textarea>
                            </div>
                        </div>
                    `);

                    handleButtonAddRemove();
                });

            }, {passive: true})
        })
    }

    // =========================================
    //          SLEEP
    // =========================================
    function sleep(ms) {
        return new Promise(resolve => setTimeout(resolve, ms));
    }

    // =========================================
    //          SAVE CONTACTS TO CSV
    // =========================================
    function csvJSON(csv) {

        var lines = csv.split("\n");

        var result = [];

        // NOTE: If your columns contain commas in their values, you'll need
        // to deal with those before doing the next step
        // (you might convert them to &&& or something, then covert them back later)
        // jsfiddle showing the issue https://jsfiddle.net/
        var headers = lines[0].split(",");

        for (var i = 1; i < lines.length; i++) {

            var obj = {};
            var currentline = lines[i].split(",");

            for (var j = 0; j < headers.length; j++) {
                obj[headers[j]] = currentline[j];
            }
            result.push(obj);
        }
        //return result; //JavaScript object
        return JSON.stringify(result); //JSON
    }

    // =========================================
    //          APPEND ONE SESSION
    // =========================================
    function messageCard(tabCounter, contentCounter, section) {
        var messageTabHtml = addMessageTab(tabCounter, section);
        var messageContentHtml = addMessageContent(contentCounter, section);
        var addMessageBtnHtml = addMessageBtn(section);
        var removeMessageBtnHtml = removeMessageBtn(section);

        return (`<div class="card messages-card-honeycomb">
                <img class="card-img-top honeycomb honeycomb-top-right" src="../static/assets/images/gold_honeycomb_top_right.png" alt="Card image">
                <div class="card-body card-img-overlay">
                    <div class="row">
                        <div class="col-lg-12 justify-content-start">
                            <h4 class="card-title text-themecolor">Adicionar Mensagens</h4>
                        </div>
                        <div class="col-lg-12 justify-content-end">
                            <div class="row justify-content-end">
                                ${addMessageBtnHtml}
                                ${removeMessageBtnHtml}
                            </div>
                        </div>
                    </div>
                    <div class="tabs tabs-msg container " id="id_tabs-msg">
                        <ul class="nav nav-tabs" role="tablist" id="id_nav_tabs" data-navtabholder-message="1"
                            data-section="${section}">
                            ${messageTabHtml}
                        </ul>
        <div class="tab-content tabcontent-border" id="id_content_holder" data-section="${section}">
            ${messageContentHtml}
        </div>
        </div>
        </div>
        </div>`)
    }

    function imageInput(section) {
        return (`
            <div class="col-lg-6 col-md-6">
                <div class="card attachimage-card-honeycomb">
                    <img class="card-img-top honeycomb honeycomb-down-left-small"
                         src="../static/assets/images/gold_honeycomb_down_left.png" alt="Card image">
                    <div class="card-body card-img-overlay container-fluid p-t-20">
                        <h4 class="card-title text-themecolor">Anexar Imagem</h4>
                        <label for="input-file-now">Escolha uma imagem para enviar com a
                            mensagem</label>
                        <input type="file" id="input-file-now"
                        class="dropify image-input" data-allowed-file-extensions="jpeg jpg png"
                        data-max-file-size="3M" data-section="${section}">
                    </div>
                </div>
            </div>
        `);
    }

    function imageCaption(section) {
        return (`
            <div class="col-md-6 col-lg-6">
                <div class=" card imagecaption-card-honeycomb">
                    <img class="card-img-top honeycomb honeycomb-down-right-small"
                         src="../static/assets/images/gold_honeycomb_down_right.png"
                         alt="Card image">
                    <div class="card-body card-img-overlay">
                        <h4 class="card-title text-themecolor">Legenda</h4>
                        <label>Se desejar incluir uma lengenda para imagem digite abaixo.
                            (opcional)</label>
                        <textarea name="image_caption" cols="40" rows="9"
                                  class="form-control col-lg-auto"
                                  required=""
                                  id="id_image_caption"
                                  placeholder="Digite aqui..."
                                  data-section="${section}"></textarea>
                    </div>
                </div>
            </div>
        `);
    }

    function contactList(section) {
        return (`
            <div class="col-lg-6 col-md-6">
                <div class="card card-honeycomb">
                    <img class="card-img-top honeycomb honeycomb-top-left-small"
                         src="../static/assets/images/gold_honeycomb_top_left.png"
                         alt="Card image">
                    <div class="card-body card-img-overlay">
                        <h4 class="card-title text-themecolor">Contatos</h4>
                        <div class="bootstrap-table">
                            <div class="fixed-table-container m-t-20"
                                 style="height: 250px; ">
                                <table class="table-hover table">
                                    <thead class="justify-content-around">
                                    <tr class="justify-content-around">
                                        <th><h5 class="text-themecolor">Nome</h5></th>
                                        <th><h5 class="text-themecolor">Número</h5></th>
                                    </tr>
                                    </thead>
                                </table>
                                <div class="fixed-table-body"
                                     style="position: relative; height: 180px; overflow: auto; display: block;">
                                    <table class="table table-hover "
                                           data-toggle="table" data-height="100"
                                           data-sort-order="desc"
                                           data-mobile-responsive="true">
                                        <tbody id='id_table_holder' data-section="${section}">

                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div class="form-group">
                            <label>Importar Contatos</label>
                            <div class="fileinput fileinput-new input-group"
                                 data-provides="fileinput" data-section="${section}">
                                <div class="form-control" data-trigger="fileinput" data-section="${section}"><i
                                        class="glyphicon glyphicon-file fileinput-exists" data-section="${section}"></i>
                                    <span
                                            class="fileinput-filename"
                                            id="id_contact_list" data-section="${section}"></span></div>
                                <span class="input-group-addon btn btn-default btn-file" data-section="${section}"> <span
                                        class="fileinput-new" data-section="${section}">Selecionar</span> <span
                                        class="fileinput-exists" data-section="${section}">Mudar</span>
                                    <input type="hidden" id="id_input_hidden_csv" data-section="${section}">
                                    <input class="input-csv" type="file" id="id_input_csv" accept=".csv" name="..."
                                           data-allowed-file-extensions="csv" data-section="${section}"> </span>
                                <a href="#" id="id-remove-file"
                                   class="input-group-addon btn btn-default fileinput-exists"
                                   data-dismiss="fileinput">Remover</a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `)
    }

    function settingsCard(section) {
        return (`
            <div class="col-lg-6 col-md-6">
                <div class="card card-honeycomb" style="height: 454px">
                    <img class="card-img-top honeycomb honeycomb-top-right-small"
                         src="../static/assets/images/gold_honeycomb_top_right.png"
                         alt="Card image">
                    <div class="card-body card-img-overlay container-fluid m-t-20">
                        <form class="form-material">
                            <h4 class="card-title text-themecolor">Configurações</h4>
                            <label class="card-title">Defina o Intervalo entre
                                Mensagens</label>
                            <div class="row form-group justify-content-start">
                                <p class="text text-themecolor">Mínimo: </p>
                                <input id="id_delay_min"
                                       class="form-control "
                                       type="text" name="interval_min" required=""
                                       placeholder="60" value="60"
                                       data-section="${section}">

                                <p>segundos</p>
                            </div>
                            <div class="row form-group justify-content-start">
                                <p class="text text-themecolor">Máximo: </p>
                                <input data-location="" id="id_delay_max"
                                       class="form-control"
                                       type='text' name="interval_max"
                                       required=""
                                       placeholder="180" value="180"
                                       data-section="${section}">
                                <p>segundos</p>
                            </div>
                            <div class="row form-group justify-content-start">
                                <p class="text text-themecolor">Modo de Digitação: </p>
                                <select class="custom-select col-12"
                                        id="inlineFormCustomSelect"
                                        data-section="${section}">
                                    <option value="1" data-section="${section}">Lento - digitação humana: 38 a 50
                                        ppm.(recomendado)
                                    </option>
                                    <option value="2" data-section="${section}">Médio - digitação humana rápida:
                                        maior que 70 ppm
                                    </option>
                                    <option value="3" data-section="${section}">Rápido - superhumano, sem pausas
                                    </option>
                                    <option value="4" data-section="${section}">Copia e Cola (não recomendado)
                                    </option>
                                </select>
                            </div>

                        </form>
                    </div>
                </div>
                <div class="container-fluid justify-content-center"
                     style="display: flex; align-items: center; justify-content: center;">
                    <button data-action="send_message" id='id-send-btn-${section}'
                            class="btn btn-warning btn-send-message m-b-30"
                            style="width: 100%;"
                            data-section="${section}">
                        <i class="fa fa-send fa-lg p-10"> Iniciar Sessão</i>
                    </button>
                </div>
            </div>
        `);
    }

    function addMessageBtn(section) {
        return (`
        <button class="btn btn-outline-success add-message" type="submit"
                data-section="${section}" name="add_message" id="add-message-s-${section}"
                value="add">Adicionar
        </button>
    `);
    }

    function removeMessageBtn(section) {
        return (`
        <button class=" btn-outline-danger m-l-30 m-r-20 remove-message" type="submit"
                data-section="${section}" name="remove_message" id="id-remove-message-s-${section}"
                value="remove">Remover
        </button>
    `);
    }

    function addMessageTab(tabCounter, section) {
        var active = "active";
        var animation = "";
        if (tabCounter > 0) {
            active = "";
            animation = "animate__animated animate__zoomIn";
        }
        return (`
            <li class="nav-item message-tab-item ${animation}" data-section="${section}">
                <a class="nav-link nav-link-msg ${active}" data-toggle="tab" data-for-tab="${tabCounter + 1}"
                id="${tabCounter + 1}" data-section="${section}" href="#home" role="tab">
                    <span class="hidden-sm-up"><i class="ti-home"></i></span>
                    <span class="hidden-xs-down">M${tabCounter + 1}</span>
                </a>
            </li>
        `);
    }

    function addMessageContent(contentCounter, section) {
        var active = "active";
        if (contentCounter > 0) {
            active = ""
        }
        return (`
                <div class="tab-pane tab-pane-msg ${active}" data-id='${contentCounter + 1}' data-messagePane-section="${contentCounter + 1}"
                    data-section="${section}" role="tabpanel">
                    <div class=" row p-10 d-flex justify-content-around container-fluid">
                        <textarea name="msg_area" cols="40" rows="12"
                                  data-section="${section}"
                                  class="form-control col-lg-11 m-l-30 msg-area-content" required=""
                                  id="id_msg_area_1"></textarea>
                    </div>
                </div>
            `);
    }

    $(document).ready(function () {
        handleListeners();
        handleButtonAddRemove();
        handleAddRemoveSections();
        dropifyListener();
    });
</script>
<script>
    $(document).ready(() => {
        $(".group-switch").on('change', function () {
            var isChecked = document.getElementById("id_switch_name_link").checked;
            var labelLink = document.getElementById("id_label_link_group");
            var labelName = document.getElementById("id_label_name_group");
            if (isChecked) {
                console.log(`is checked`);// To verify

                labelLink.classList.add(`text-themecolor`);
                labelName.classList.remove(`text-themecolor`)
            } else {
                console.log(`not checked`);// To verify
                labelLink.classList.remove(`text-themecolor`);
                labelName.classList.add(`text-themecolor`)
            }
        });
        $("#statusid").on("click", () => {
            console.log(document.getElementById("id_switch_name_link").checked)
        })
    });


</script>
{% endblock pagescripts %}